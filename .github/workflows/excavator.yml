name: Excavator
on:
  workflow_dispatch:
  schedule:
    - cron: "18 * * * *"

concurrency:
  group: manifest-check-lock

jobs:
  check-scoop-version:
    name: Check Scoop Version
    runs-on: windows-latest
    outputs:
      ScoopNewVersion: ${{ steps.scoop-new-version.outputs.ScoopNewVersion }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Check Scoop Version
        id: scoop-new-version
        shell: pwsh
        run: |
          .\script\check-scoop-version.ps1

      - name: Reopen Issue
        if: steps.scoop-new-version.outputs.ScoopNewVersion != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const issue = await github.rest.issues.get({
                issue_number: 8,
                owner: context.repo.owner,
                repo: context.repo.repo
              });

              if (issue.data.state === 'closed') {
                await github.rest.issues.update({
                  issue_number: 8,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open'
                });
                console.log('Issue #8 已重新打开');
              } else {
                console.log('Issue #8 已是打开状态');
              }
            } catch (error) {
              console.error('重新打开 Issue 失败:', error);
              throw error;
            }

  excavate:
    name: Excavate
    runs-on: windows-latest
    env:
      # github_pat_x,github_pat_y
      TOKEN_POOL: ${{ secrets.TOKEN_POOL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.repository.default_branch}}

      - name: Install module
        env:
          PS_MODULE_LIST: ${{ secrets.PS_MODULE_LIST }}
        shell: pwsh
        run: $env:PS_MODULE_LIST -split ',' | ForEach-Object { Install-Module $_ -Repository PSGallery -Force }

      - name: Get latest changes
        run: git pull

      - name: Excavate
        uses: ScoopInstaller/GithubActions@main
        # uses: abgox/ScoopInstaller-GithubActions@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SCOOP_BRANCH: develop
          SKIP_UPDATED: 1
          THROW_ERROR: 0

      - name: Check rate limit
        shell: pwsh
        run: |
          # Check rate limit for each token
          Write-Output "::group::GitHub API Rate Limits"
          $headers = @{
              "Accept" = "application/vnd.github.v3+json"
              "X-GitHub-Api-Version" = "2022-11-28"
          }
          $tokens = $env:TOKEN_POOL.Split(',') | ForEach-Object { $_.Trim() } | Where-Object { $_ }
          for ($i = 0; $i -lt $tokens.Count; $i++) {
              $t = $tokens[$i]
              $headers["Authorization"] = "Bearer $t"
              try {
                  $response = Invoke-RestMethod -Uri "https://api.github.com/rate_limit" -Headers $headers
                  Write-Output $response.rate
              }
              catch {
                  Write-Output "Token $($i + 1) : Failed to check rate limit"
              }
          }
          Write-Output "::endgroup::"

  update-content:
    name: Update Content
    needs: excavate
    runs-on: windows-latest
    outputs:
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.repository.default_branch}}

      - name: Generate list and update content
        shell: pwsh
        run: |
          .\script\generate-list.ps1

      - name: Check for changes
        id: changes
        shell: pwsh
        run: |
          git add -u
          if (git status --porcelain) {
              "has_changes=true" >> $env:GITHUB_OUTPUT
          } else {
              "has_changes=false" >> $env:GITHUB_OUTPUT
          }

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        shell: pwsh
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -u
          # scoop update 会忽略以 (chore) 开头的提交
          git commit -m "(chore): automatically update some content [skip ci]"
          git push

  update-docs:
    name: Update Docs
    needs: update-content
    if: needs.update-content.outputs.has_changes == 'true'
    runs-on: windows-latest
    steps:
      - name: Update Docs
        shell: pwsh
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git clone --depth 1 https://${{ secrets.PAT_TOKEN }}@github.com/abgox/abyss-docs.git abyss-docs
          cd abyss-docs
          .\scripts\update-app-list.ps1
          git add -u
          git commit -m "chore: automatically update some content"
          git push --force

  sync-repos:
    name: Sync Repos
    needs: update-content
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: Yikun/hub-mirror-action@master
        with:
          src: github/abgox
          dst: gitee/abgox
          dst_key: ${{ secrets.GITEE_SSH_PRIVATE_KEY }}
          dst_token: ""
          force_update: true
          static_list: ${{ github.event.repository.name }}
