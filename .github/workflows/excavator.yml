name: Excavator
on:
  workflow_dispatch:
  schedule:
    # At minute 30 past every 4th hour.
    - cron: "30 */4 * * *"

concurrency:
  group: excavator-workflow-${{ github.ref }}

jobs:
  excavate:
    name: Excavate
    runs-on: windows-latest
    env:
      TOKEN_1: ${{ secrets.TOKEN_1 }}
      TOKEN_2: ${{ secrets.TOKEN_2 }}
      TOKEN_3: ${{ secrets.TOKEN_3 }}
      TOKEN_4: ${{ secrets.TOKEN_4 }}
      TOKEN_5: ${{ secrets.TOKEN_5 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Get latest changes
        run: git pull

      - name: Excavate
        uses: ScoopInstaller/GithubActions@main
        # uses: abgox/ScoopInstaller-GithubActions@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SCOOP_BRANCH: develop
          SKIP_UPDATED: 1
          THROW_ERROR: 0

  # workflow-keepalive:
  #   if: github.event_name == 'schedule'
  #   runs-on: ubuntu-latest
  #   permissions:
  #     actions: write
  #   steps:
  #     - uses: abgox/gh-workflow-keepalive@main

  check-scoop-version:
    runs-on: windows-latest
    outputs:
      ScoopNewVersion: ${{ steps.scoop-new-version.outputs.ScoopNewVersion }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Check Scoop Version
        id: scoop-new-version
        shell: pwsh
        run: |
          .\bin\check-scoop-version.ps1

      - name: Reopen Issue
        if: steps.scoop-new-version.outputs.ScoopNewVersion != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              const issue = await github.rest.issues.get({
                issue_number: 8,
                owner: context.repo.owner,
                repo: context.repo.repo
              });

              if (issue.data.state === 'closed') {
                await github.rest.issues.update({
                  issue_number: 8,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open'
                });
                console.log('Issue #8 已重新打开');
              } else {
                console.log('Issue #8 已是打开状态');
              }
            } catch (error) {
              console.error('重新打开 Issue 失败:', error);
              throw error;
            }
